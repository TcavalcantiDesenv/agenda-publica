<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda — Supabase (Standalone Dark)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%;}
    /* Paleta dark */
    .cal-wrapper { background:#111827; }
    .cal-surface { background:#111827; }
    .cal-title { color:#e5e7eb; }
    .cal-cell { background:#1f2937; border-color:#374151; }
    .cal-cell:hover { box-shadow: inset 0 0 0 1px #6b7280; }
    .btn-primary { background:#7c3aed; }
    .btn-primary:hover { background:#6d28d9; }

    /* Pills com gradiente + pontinho branco */
    .pill { border-radius:12px; padding:6px 10px; font-size:12px; display:flex; align-items:center; gap:8px; font-weight:700; color:#fff; box-shadow:0 4px 10px rgba(0,0,0,.25); position:relative; }
    .pill .dot { width:8px; height:8px; border-radius:9999px; background:#fff; opacity:.95; }
    .pill-actions{ position:absolute; right:6px; top:6px; display:flex; gap:6px; opacity:.0; transition:opacity .15s ease; }
    .pill:hover .pill-actions{ opacity:1; }
    .icon-btn{ width:22px; height:22px; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; background:rgba(0,0,0,.18); }
    .icon-btn:hover{ background:rgba(0,0,0,.32); }
    .icon{ width:14px; height:14px; fill:#fff; opacity:.9 }

    /* Paleta de gradientes (inspirada no anexo) */
    .grad-violet{ background-image:linear-gradient(135deg,#c084fc,#a78bfa); }
    .grad-green{ background-image:linear-gradient(135deg,#34d399,#10b981); }
    .grad-sky  { background-image:linear-gradient(135deg,#38bdf8,#22d3ee); }
    .grad-rose { background-image:linear-gradient(135deg,#fb7185,#ef4444); }
    .grad-amber{ background-image:linear-gradient(135deg,#fbbf24,#f59e0b); }
    .grad-teal { background-image:linear-gradient(135deg,#2dd4bf,#14b8a6); }
    .grad-indigo{background-image:linear-gradient(135deg,#818cf8,#6366f1);}    
    .grad-pink { background-image:linear-gradient(135deg,#f472b6,#ec4899); }
    .muted { color:#9ca3af; }
  </style>
</head>
<body class="min-h-full bg-gray-900 text-gray-100">
  <div id="app" class="w-full max-w-6xl mx-auto p-4"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === Config Supabase ===
    const SUPABASE_URL = "https://vbbegtdxhgtewkqdqmat.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiYmVndGR4aGd0ZXdrcWRxbWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MzEyMTEsImV4cCI6MjA3MDUwNzIxMX0.3v7Smy-mUwlrtkjM0_YrwP5uG17PYKSdj6_Tb2AnV7k";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === Utilidades de data ===
    const months = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
    const weekDays = ["Seg","Ter","Qua","Qui","Sex","Sáb","Dom"]; // semana começando na segunda

    function startOfWeek(d){ const c=new Date(d); const js=c.getDay(); const off=(js+6)%7; c.setDate(c.getDate()-off); c.setHours(0,0,0,0); return c; }
    function endOfWeek(d){ const s=startOfWeek(d); const e=new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e; }
    function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
    function dayKey(d){ return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`; }

    function buildMonthMatrix(year, monthIndex){
      const firstDay=new Date(year,monthIndex,1); const lastDay=new Date(year,monthIndex+1,0);
      const jsFirst=firstDay.getDay(); const offset=(jsFirst+6)%7; const cells=[];
      for(let i=0;i<offset;i++){ cells.push(new Date(year,monthIndex,1-(offset-i))); }
      for(let d=1; d<=lastDay.getDate(); d++) cells.push(new Date(year,monthIndex,d));
      const rem=cells.length%7; if(rem!==0){ for(let i=1;i<=7-rem;i++) cells.push(new Date(year,monthIndex+1,i)); }
      const weeks=[]; for(let i=0;i<cells.length;i+=7) weeks.push(cells.slice(i,i+7));
      return weeks;
    }

    function getQueryParamInt(name){
      // Aceita tanto ?corretorId= quanto o possível typo ?corrtorId=
      const params = new URLSearchParams(location.search);
      const raw = params.get(name) ?? params.get(name.replace('corretor','corrtor'));
      if(!raw) return null; const n = Number(raw); return Number.isFinite(n)? n : null; 
    }

    // === Estado ===
    const state = {
      year: (new Date()).getFullYear(),
      month: (new Date()).getMonth(),
      view: 'month', // 'month' | 'week' | 'day'
      cursorDate: new Date(),
      items: [],
      loading: false,
      modalOpen: false,
      selectedDate: null,
      form: { cliente: '', atividade: '', hora: '09:00' },
      corretorId: getQueryParamInt('corretorId'),
      editingId: null // quando não-null, modal está em modo edição
    };

    function setState(patch){ Object.assign(state, patch); render(); }

    // Hash determinístico para colorir sempre igual por evento
    function stableHash(str){ let h=2166136261; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h+= (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24);} return h>>>0; }
    const gradientClasses = ['grad-violet','grad-green','grad-sky','grad-rose','grad-amber','grad-teal','grad-indigo','grad-pink'];
    function colorForItem(it){
      const key = `${it.id||''}|${it.Cliente||''}|${it.Atividade||''}|${it.corretorId||''}`;
      const idx = stableHash(key) % gradientClasses.length;
      return gradientClasses[idx];
    }

        // CRUD Supabase
async function fetchRange(){
      setState({ loading: true });
      let rangeStart, rangeEnd;
      if(state.view==='month'){
        rangeStart = new Date(state.year, state.month, 1, 0,0,0,0);
        rangeEnd = new Date(state.year, state.month+1, 0, 23,59,59,999);
      } else if(state.view==='week'){
        rangeStart = startOfWeek(state.cursorDate);
        rangeEnd = endOfWeek(state.cursorDate);
      } else { // day
        rangeStart = new Date(state.cursorDate); rangeStart.setHours(0,0,0,0);
        rangeEnd = new Date(state.cursorDate); rangeEnd.setHours(23,59,59,999);
      }
      try{
        const { data, error } = await supabase
          .from('Agenda')
          .select('*')
          .gte('DataAgendada', rangeStart.toISOString().slice(0,19))
          .lte('DataAgendada', rangeEnd.toISOString().slice(0,19))
          .eq('corretorId', state.corretorId) // filtra pelo corretor da URL
          .order('DataAgendada', { ascending: true });
        if(error) throw error;
        setState({ items: data||[], loading:false });
      }catch(e){ console.error(e); setState({ loading:false }); }
    }



    async function saveAgenda(){
      if(!state.selectedDate) return;
      const [hh,mm] = state.form.hora.split(':').map(Number);
      const when = new Date(state.selectedDate); when.setHours(hh||0, mm||0, 0, 0);
      const payload = {
        Cliente: state.form.cliente || null,
        Atividade: state.form.atividade || null,
        Ativo: true,
        DataAgendada: when.toISOString().slice(0,19),
        corretorId: state.corretorId
      };
      if(state.editingId){
        const { data, error } = await supabase.from('Agenda').update(payload).eq('id', state.editingId).select('*').single();
        if(error){ alert('Erro ao atualizar: '+error.message); return; }
        // atualiza no estado local
        const newList = state.items.map(it => it.id===data.id ? data : it);
        setState({ items:newList, modalOpen:false, editingId:null });
      } else {
        const { data, error } = await supabase.from('Agenda').insert(payload).select('*').single();
        if(error){ alert('Erro ao salvar: '+error.message); return; }
        setState({ items: state.items.concat([data]), modalOpen:false });
      }
    }

    async function deleteAgenda(id){
      if(!confirm('Excluir este agendamento?')) return;
      const { error } = await supabase.from('Agenda').delete().eq('id', id);
      if(error){ alert('Erro ao excluir: '+error.message); return; }
      setState({ items: state.items.filter(it => it.id !== id) });
    }

    // Agrupa por dia
    function groupByDay(items){
      const map = new Map();
      for(const it of items){ if(!it.DataAgendada) continue; const d=new Date(it.DataAgendada); const key=dayKey(d); if(!map.has(key)) map.set(key, []); map.get(key).push(it); }
      for(const arr of map.values()) arr.sort((a,b)=> new Date(a.DataAgendada||0)-new Date(b.DataAgendada||0));
      return map;
    }

    // Navegação
    function goPrev(){
      if(state.view==='month'){
        const m=state.month-1; if(m<0) setState({ month:11, year: state.year-1 }); else setState({ month:m });
      } else if(state.view==='week'){
        const d=new Date(state.cursorDate); d.setDate(d.getDate()-7); setState({ cursorDate:d });
      } else { const d=new Date(state.cursorDate); d.setDate(d.getDate()-1); setState({ cursorDate:d }); }
      fetchRange();
    }
    function goNext(){
      if(state.view==='month'){
        const m=state.month+1; if(m>11) setState({ month:0, year: state.year+1 }); else setState({ month:m });
      } else if(state.view==='week'){
        const d=new Date(state.cursorDate); d.setDate(d.getDate()+7); setState({ cursorDate:d });
      } else { const d=new Date(state.cursorDate); d.setDate(d.getDate()+1); setState({ cursorDate:d }); }
      fetchRange();
    }

    function openModalFor(day, editing=null){
      if(editing){
        // preencher form com dados existentes
        const d = new Date(editing.DataAgendada);
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        setState({
          selectedDate: new Date(d.getFullYear(), d.getMonth(), d.getDate()),
          modalOpen: true,
          editingId: editing.id,
          form: { cliente: editing.Cliente||'', atividade: editing.Atividade||'', hora: `${hh}:${mm}` }
        });
      } else {
        setState({ selectedDate: day, modalOpen: true, editingId:null, form: { ...state.form, hora: '09:00' } });
      }
    }

    // SVG helpers
    function svgEdit(){return '<svg class="icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm14.71-9.04a1.003 1.003 0 0 0 0-1.42l-2.5-2.5a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.99-1.66z"/></svg>';}
    function svgTrash(){return '<svg class="icon" viewBox="0 0 24 24"><path d="M6 7h12v2H6V7zm2 3h8l-1 10H9L8 10zm3-6h2l1 1h5v2H5V5h5l1-1z"/></svg>';}

    // Render principal
    function render(){
      const app=document.getElementById('app');
      const itemsByDay = groupByDay(state.items);

      const currentLabel = (function(){
        if(state.view==='month') return `${months[state.month]} / ${state.year}`;
        if(state.view==='week') { const s=startOfWeek(state.cursorDate); const e=endOfWeek(state.cursorDate); return `${s.toLocaleDateString()} – ${e.toLocaleDateString()}`; }
        return state.cursorDate.toLocaleDateString();
      })();

      function pillHtml(it, time){
        return `<div class="pill ${colorForItem(it)}" data-id="${it.id}">
          <span class="dot"></span>
          <div class="truncate"><div class="truncate">${it.Cliente||'(sem nome)'}${time?'' : ''}</div>${time?`<div class="opacity-90 truncate">${time} · ${it.Atividade||'(atividade)'} </div>`:`<div class="opacity-90 truncate">${it.Atividade||'(atividade)'}</div>`}</div>
          <div class="pill-actions">
            <button class="icon-btn" title="Editar" data-action="edit" data-id="${it.id}">${svgEdit()}</button>
            <button class="icon-btn" title="Excluir" data-action="delete" data-id="${it.id}">${svgTrash()}</button>
          </div>
        </div>`;
      }

      function monthGrid(){
        const matrix = buildMonthMatrix(state.year, state.month);
        const grid = matrix.map((week, wi)=> week.map((date, di)=>{
          const key=dayKey(date); const daily=itemsByDay.get(key)||[]; const today=sameDay(date, new Date());
          const isCurrent = (date.getMonth()===state.month && date.getFullYear()===state.year);
          return `
            <div class="relative min-h-[120px] rounded-xl border p-2 cal-cell ${isCurrent?"":"opacity-60"} ${today?"ring-2 ring-blue-400":""}">
              <div class="flex items-center justify-between mb-2">
                <div class="text-sm text-gray-300 font-semibold">${date.getDate()}</div>
                <div class="flex items-center gap-1">
                  <button class="text-xs px-2 py-1 rounded-lg border border-gray-600 text-gray-200 hover:bg-gray-700" data-action="open" data-date="${date.toISOString()}">+ Agendar</button>
                </div>
              </div>
              <div class="flex flex-col gap-2">
                ${daily.map(it=>{
                  const d=it.DataAgendada?new Date(it.DataAgendada):null; const time=d?d.toTimeString().slice(0,5):'';
                  return pillHtml(it, time);
                }).join('')}
              </div>
            </div>`;
        }).join('')).join('');
        return `<div class="grid grid-cols-7 gap-2">${grid}</div>`;
      }

      function weekGrid(){
        const s=startOfWeek(state.cursorDate); const days=[...Array(7)].map((_,i)=> new Date(s.getFullYear(), s.getMonth(), s.getDate()+i));
        const grid = days.map((date, di)=>{
          const key=dayKey(date); const daily=itemsByDay.get(key)||[]; const today=sameDay(date,new Date());
          return `
            <div class="relative min-h-[260px] rounded-xl border p-2 cal-cell ${today?"ring-2 ring-blue-400":""}">
              <div class="flex items-center justify-between mb-2">
                <div>
                  <div class="text-xs text-gray-400">${weekDays[(di)%7]}</div>
                  <div class="text-base font-semibold text-gray-200">${date.getDate()} ${months[date.getMonth()].slice(0,3)}</div>
                </div>
                <div class="flex items-center gap-1">
                  <button class="text-xs px-2 py-1 rounded-lg border border-gray-600 text-gray-200 hover:bg-gray-700" data-action="open" data-date="${date.toISOString()}">+ Agendar</button>
                </div>
              </div>
              <div class="flex flex-col gap-2">
                ${daily.length===0?'<div class="text-xs text-gray-400">Sem compromissos</div>':''}
                ${daily.map(it=>{
                  const d=it.DataAgendada?new Date(it.DataAgendada):null; const time=d?d.toTimeString().slice(0,5):'';
                  return pillHtml(it, time);
                }).join('')}
              </div>
            </div>`;
        }).join('');
        return `<div class="grid grid-cols-7 gap-2">${grid}</div>`;
      }

      function dayGrid(){
        const key = dayKey(state.cursorDate); const daily=itemsByDay.get(key)||[];
        const events = daily.map(it=>{
          const d=it.DataAgendada?new Date(it.DataAgendada):null; const hh=d?d.getHours():8; const mm=d?d.getMinutes():0; const top=((hh+mm/60)-8)*48;
          return `<div style="top:${top}px" class="absolute left-0 right-0 ml-1 mr-2">${pillHtml(it, d?d.toTimeString().slice(0,5):'')}</div>`
        }).join('');
        return `
          <div class="grid grid-cols-1 gap-2">
            <div class="rounded-xl border p-3 cal-cell">
              <div class="flex items-center justify-between mb-3">
                <div class="text-lg font-semibold text-gray-200">${state.cursorDate.toLocaleDateString(undefined,{weekday:'long',month:'long',day:'numeric'})}</div>
                <div class="flex items-center gap-1">
                  <button class="text-xs px-2 py-1 rounded-lg border border-gray-600 text-gray-200 hover:bg-gray-700" data-action="open" data-date="${state.cursorDate.toISOString()}">+ Agendar</button>
                </div>
              </div>
              <div class="grid" style="grid-template-columns: 60px 1fr; gap:12px;">
                <div class="flex flex-col">
                  ${Array.from({length:12},(_,i)=>8+i).map(h=>`<div class="h-12 text-xs text-right pr-2 text-gray-400">${String(h).padStart(2,'0')}:00</div>`).join('')}
                </div>
                <div class="relative">
                  ${Array.from({length:12},(_,i)=>`<div class="h-12 border-b border-dashed border-gray-700"></div>`).join('')}
                  ${events}
                </div>
              </div>
            </div>
          </div>`;
      }

      const weekHeader = state.view!=='day' ? `
        <div class="grid grid-cols-7 gap-2 mb-2">${weekDays.map(d=>`<div class="text-center text-sm font-medium text-gray-400">${d}</div>`).join('')}</div>
      ` : '';

      const monthSelectors = state.view==='month' ? `
        <select id="monthSel" class="border border-gray-600 bg-gray-800 text-gray-100 rounded-xl px-3 py-2">${months.map((m,i)=>`<option value="${i}" ${i===state.month?'selected':''}>${m}</option>`).join('')}</select>
        <input id="yearInp" type="number" class="border border-gray-600 bg-gray-800 text-gray-100 rounded-xl px-3 py-2 w-28" value="${state.year}" />
      `: '';

      app.innerHTML = `
        <div class="cal-wrapper rounded-2xl p-4">
          <div class="cal-surface rounded-2xl p-4 shadow">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
              <div class="flex items-center gap-2">
                <button class="w-9 h-9 rounded-lg bg-gray-800 text-gray-300 hover:bg-gray-700" data-action="prev">◀</button>
                <button class="w-9 h-9 rounded-lg bg-gray-800 text-gray-300 hover:bg-gray-700" data-action="next">▶</button>
              </div>
              <div class="cal-title text-xl font-semibold">${currentLabel}</div>
              <button class="btn-primary px-4 py-2 rounded-lg text-white font-medium flex items-center gap-2" data-action="open" data-date="${new Date().toISOString()}"><span class="text-lg">+</span> Adicionar</button>
            </div>
            <div class="flex items-center gap-2 mb-3">
              <div class="flex rounded-xl overflow-hidden border border-gray-700">
                <button class="px-3 py-2 text-sm ${state.view==='month'?'bg-gray-900 text-white':''}" data-view="month">Mês</button>
                <button class="px-3 py-2 text-sm ${state.view==='week'?'bg-gray-900 text-white':''}" data-view="week">Semana</button>
                <button class="px-3 py-2 text-sm ${state.view==='day'?'bg-gray-900 text-white':''}" data-view="day">Dia</button>
              </div>
              ${monthSelectors}
            </div>
            ${weekHeader}
            ${state.view==='month' ? monthGrid() : state.view==='week' ? weekGrid() : dayGrid()}
            ${state.loading?'<div class="fixed inset-0 pointer-events-none flex items-center justify-center"><div class="bg-gray-800 border border-gray-700 rounded-xl px-4 py-2 shadow text-gray-100">Carregando…</div></div>':''}
          </div>
        </div>

        <!-- Modal -->
        <div id="modal" class="${state.modalOpen?'':'hidden'} fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50">
          <div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-5 border border-gray-700">
            <div class="text-lg font-semibold mb-3 text-gray-100">${state.editingId? 'Editar agendamento' : 'Novo agendamento'}</div>
            <div class="space-y-3">
              <div class="text-sm text-gray-300">Data selecionada: ${state.selectedDate? new Date(state.selectedDate).toLocaleDateString():''}</div>
              <label class="block">
                <span class="text-sm">Cliente</span>
                <input id="inpCliente" class="mt-1 w-full bg-gray-900 border border-gray-700 rounded-xl px-3 py-2 text-gray-100" placeholder="Nome do cliente" value="${state.form.cliente}">
              </label>
              <label class="block">
                <span class="text-sm">Atividade</span>
                <input id="inpAtividade" class="mt-1 w-full bg-gray-900 border border-gray-700 rounded-xl px-3 py-2 text-gray-100" placeholder="Descrição da atividade" value="${state.form.atividade}">
              </label>
              <label class="block">
                <span class="text-sm">Hora</span>
                <input id="inpHora" type="time" class="mt-1 w-full bg-gray-900 border border-gray-700 rounded-xl px-3 py-2 text-gray-100" value="${state.form.hora}">
              </label>
            </div>
            <div class="flex justify-end gap-2 mt-5">
              <button class="px-4 py-2 rounded-lg bg-gray-700 text-gray-200" data-action="close-modal">Cancelar</button>
              <button class="px-4 py-2 rounded-lg btn-primary text-white" data-action="save">${state.editingId? 'Atualizar' : 'Salvar'}</button>
            </div>
            ${state.corretorId==null?'<div class="mt-3 text-xs text-yellow-400">Informe ?corretorId=NUMERO na URL para visualizar e salvar agendamentos.</div>':''}
          </div>
        </div>
      `;

      // Eventos gerais
      const prevBtn = app.querySelector('[data-action="prev"]'); if(prevBtn) prevBtn.onclick = ()=> goPrev();
      const nextBtn = app.querySelector('[data-action="next"]'); if(nextBtn) nextBtn.onclick = ()=> goNext();
      app.querySelectorAll('[data-view]').forEach(btn=> btn.onclick = ()=>{ setState({ view: btn.getAttribute('data-view') }); fetchRange(); });

      const monthSel = app.querySelector('#monthSel'); if(monthSel){ monthSel.onchange = (e)=>{ setState({ month: Number(e.target.value) }); fetchRange(); } }
      const yearInp = app.querySelector('#yearInp'); if(yearInp){ yearInp.onchange = (e)=>{ setState({ year: Number(e.target.value) }); fetchRange(); } }

      app.querySelectorAll('[data-action="open"]').forEach(btn=>{
        btn.onclick = ()=>{ const d=new Date(btn.getAttribute('data-date')); openModalFor(d); };
      });

      // Ações dos pills (editar/excluir)
      app.querySelectorAll('[data-action="edit"]').forEach(btn=>{
        btn.onclick = ()=>{
          const id = Number(btn.getAttribute('data-id'));
          const it = state.items.find(x=> x.id === id);
          if(!it) return;
          openModalFor(new Date(it.DataAgendada), it);
        };
      });
      app.querySelectorAll('[data-action="delete"]').forEach(btn=>{
        btn.onclick = ()=>{
          const id = Number(btn.getAttribute('data-id'));
          deleteAgenda(id);
        };
      });

      const modal = document.getElementById('modal');
      if(modal){
        const closeBtn = modal.querySelector('[data-action="close-modal"]'); if(closeBtn) closeBtn.onclick = ()=> setState({ modalOpen:false, editingId:null });
        const saveBtn = modal.querySelector('[data-action="save"]'); if(saveBtn) saveBtn.onclick = ()=>{
          state.form.cliente = modal.querySelector('#inpCliente').value;
          state.form.atividade = modal.querySelector('#inpAtividade').value;
          state.form.hora = modal.querySelector('#inpHora').value || '09:00';
          saveAgenda();
        };
      }
    }

    // Inicializa
    render();
    fetchRange();
  </script>
</body>
</html>
